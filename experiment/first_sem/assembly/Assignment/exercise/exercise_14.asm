.text
.globl main

# =================================================================
# main: プログラムの起点
# -----------------------------------------------------------------
# 演習の要件に従い、n=10でfibonacci関数を呼び出し、
# 終了する。
# =================================================================
main:
    li      $t0, 10             # 引数n=10を$t0に設定 
    jal     fibonacci           # fibonacci関数を呼び出す

    # ここで$t1に結果が格納されている (fibonacci(10) = 89)

    # プログラムを終了する
    li      $v0, 10
    syscall

# =================================================================
# fibonacci: 再帰的にフィボナッチ数を計算する関数
# -----------------------------------------------------------------
# 引数:   $t0 (n)
# 戻り値: $t1 (fibonacci(n))
# =================================================================
fibonacci:
    # --- 関数プロローグ ---
    # 再帰呼び出しに備え、戻りアドレス($ra)と現在のn($t0)を
    # スタックに保存する領域を確保する。
    # fib(n-1)の結果を一時保存する領域も確保する。
    # 合計12バイト (3ワード)
    addi    $sp, $sp, -12
    sw      $ra, 8($sp)         # 戻りアドレスを保存
    sw      $t0, 4($sp)         # 引数nを保存

    # --- ベースケース ---
    # if (n < 2), result is 1. (Cコードの n==0 または n==1 の場合に相当)
    slti    $t2, $t0, 2         # $t2 = 1 if $t0 < 2
    beq     $t2, $zero, recursive_step # if n >= 2, 再帰ステップへ

    # nが0か1の場合の処理
    li      $t1, 1              # 結果($t1)を1に設定 
    j       epilogue            # 関数の最後へジャンプ

recursive_step:
    # --- 再帰ステップ: fibonacci(n-1) + fibonacci(n-2) ---
    
    # 1. fibonacci(n-1) の計算
    addi    $t0, $t0, -1        # 引数を n-1 に設定
    jal     fibonacci           # fibonacci(n-1) を再帰呼び出し
                                # 結果は $t1 に入る
    
    # fibonacci(n-1)の結果をスタックに一時保存
    sw      $t1, 0($sp)

    # 2. fibonacci(n-2) の計算
    # スタックから元のnの値を復元
    lw      $t0, 4($sp)
    addi    $t0, $t0, -2        # 引数を n-2 に設定
    jal     fibonacci           # fibonacci(n-2) を再帰呼び出し
                                # 結果は $t1 に入る

    # 3. 結果の合計
    # fib(n-1)の結果をスタックから読み出す
    lw      $t2, 0($sp)         # $t2 = fibonacci(n-1)
    add     $t1, $t1, $t2       # $t1 = fibonacci(n-2) + fibonacci(n-1)

epilogue:
    # --- 関数エピローグ ---
    # スタックに保存したレジスタを復元
    lw      $ra, 8($sp)
    lw      $t0, 4($sp)
    # スタックポインタを元に戻す (スタック領域の縮小) 
    addi    $sp, $sp, 12

    jr      $ra                 # 呼び出し元に戻る